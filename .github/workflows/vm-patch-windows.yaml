name: Windows VM Patch via Run Command

on:
  workflow_dispatch:
    inputs:
      target_rg:
        description: "Resource group containing VMs"
        required: true
      tag_name:
        description: "Only VMs with this tag name (example: PatchGroup)"
        required: true
        default: "PatchGroup"
      tag_value:
        description: "Only VMs with this tag value (example: Nightly)"
        required: true
        default: "Nightly"
      do_install:
        description: "If true, install updates; otherwise just report"
        required: true
        default: "false"

permissions:
  contents: read
  id-token: write

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (to read scripts)
        uses: actions/checkout@v4

      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Patch tagged Windows VMs
        shell: bash
        env:
          RG: ${{ inputs.target_rg }}
          TAG_NAME: ${{ inputs.tag_name }}
          TAG_VALUE: ${{ inputs.tag_value }}
          DO_INSTALL: ${{ inputs.do_install }}
        run: |
          set -euo pipefail

          # English comments:
          # - We target VMs by tags to avoid accidental patching of everything.
          # - Script runs inside each VM via Run Command.
          # - The script prints JSON for easy log review.

          VMS=$(az vm list -g "$RG" --query "[?tags.$TAG_NAME=='$TAG_VALUE'].name" -o tsv)
          if [ -z "$VMS" ]; then
            echo "No VMs found with tag $TAG_NAME=$TAG_VALUE in RG=$RG"
            exit 0
          fi

          for vm in $VMS; do
            echo "---- VM: $vm ----"
            az vm run-command invoke \
              -g "$RG" -n "$vm" \
              --command-id RunPowerShellScript \
              --scripts @scripts/patch-windows-runcommand.ps1 \
              --parameters "DoInstall=$DO_INSTALL" \
              --query "value[0].message" -o tsv
          done
